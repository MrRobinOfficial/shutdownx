name: Build and Release

on:
  workflow_run:
    workflows: ["Bump version"]
    types:
      - completed

jobs:
  build_and_release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: "${{ secrets.PERSONAL_ACCESS_TOKEN }}"
          fetch-depth: 0 # This ensures that tags and commit history are available

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install commitizen
          pip install pyinstaller

      - name: Get the new version from Commitizen bump
        run: |
          VERSION=$(cz version)  # Get the version bumped by Commitizen
          echo "VERSION=$VERSION" >> $GITHUB_ENV  # Set the version as an environment variable

      - name: Run build script
        run: bash ./build.sh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: shutdownx
          path: dist/shutdownx.exe # Adjust if the .exe is output elsewhere.

      - name: Create GitHub release
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ env.VERSION }} # Use the version/tag from Commitizen
          name: Release v${{ env.VERSION }}
          body: |
            This release contains the latest build of ShutdownX.
            Download the `.exe` file below.
          artifacts: dist/shutdownx.exe
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }} # GitHub token to create the release
